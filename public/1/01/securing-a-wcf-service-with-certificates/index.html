<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>Securing a WCF service with Certificates - The Wandering Glitch</title>
  <meta property="og:title" content="Securing a WCF service with Certificates - The Wandering Glitch" />
  <meta name="twitter:title" content="Securing a WCF service with Certificates - The Wandering Glitch" />
  <meta name="description" content="For a client and server to talk securely with message level encryption, they both require certificates to encrypt and decrypt messages from the other. Those certificates need to be produced and installed on each machine. This post shows how that can be done, and what settings are required to work with the certificates. Thanks to Mitch Denny, who wrote a very good post on the use of certificates, which helped a lot more than some of the official documentation.">
  <meta property="og:description" content="For a client and server to talk securely with message level encryption, they both require certificates to encrypt and decrypt messages from the other. Those certificates need to be produced and installed on each machine. This post shows how that can be done, and what settings are required to work with the certificates. Thanks to Mitch Denny, who wrote a very good post on the use of certificates, which helped a lot more than some of the official documentation.">
  <meta name="twitter:description" content="For a client and server to talk securely with message level encryption, they both require certificates to encrypt and decrypt messages from the other. Those certificates need to be produced and …">
  <meta name="author" content=""/>
  <meta property="og:site_name" content="The Wandering Glitch" />
  <meta property="og:url" content="https://industrialinference.com/1/01/securing-a-wcf-service-with-certificates/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.108.0">

  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />

  <script src="/js/script.js"></script>
  <script src="/js/custom.js"></script>
  <script defer src="/js/fontawesome.js"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">The Wandering Glitch</a></h1>
    <ul class="site-navi-items">
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

  <div class="main" role="main">
    <article class="article">
      
      
      <h1 class="article-title">Securing a WCF service with Certificates</h1>
      
      <hr class="article-title-bottom">
      <ul class="article-meta">
        <li class="article-meta-date"><time>January 1, 0001</time></li>
      </ul>
      
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#configuring-the-service-endpoints">Configuring the service endpoints</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>
      <p>For a client and server to talk securely with message level encryption, they both require certificates to encrypt and decrypt messages from the other. Those certificates need to be produced and installed on each machine. This post shows how that can be done, and what settings are required to work with the certificates. Thanks to Mitch Denny, who wrote a <a href="http://notgartner.wordpress.com/2007/09/06/using-certificate-based-authentication-and-protection-with-windows-communication-foundation-wcf/">very good post</a> on the use of certificates, which helped a lot more than some of the official documentation. This post assumes that you&rsquo;re using Juval Lowy of IDesign&rsquo;s <a href="http://idesign.net/idesign/DesktopDefault.aspx?tabindex=5&amp;tabid=11">ServiceModelEx</a> extensions for WCF. If you&rsquo;re not, you should really consider these additions - they add declarative security and better validation amongst many other enhancements.</p>
<p>First you need to create a certificate for both the client and the server. Most examples demonstrate the scenario on a single machine thus glossing over the fact that in that situation you only need the one certificate. It obscures the real process of certificate exchange which I’ll show here.</p>
<p>The following is a little script (called setupcert.cmd) that will create a new certificate using makecert.exe, will add it to the ‘My’ cert store on the location machine hive of the registry. It will then export that cert for use on the other machine.</p>
<blockquote>
<pre><code>set CERT_NAME=%1
certmgr.exe -del -r LocalMachine -s My -c -n %CERT_NAME%
makecert.exe -sr LocalMachine -ss MY -a sha1 -n CN=%CERT_NAME% -sky exchange -pe
certmgr.exe /put /c /r LocalMachine /n %CERT_NAME% /s my %CERT_NAME%.publickey.cer
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
</blockquote>
<p>You pass one parameter to the script, which is the common name you want to give to the certificate. For instance, you could call it “ServerSide” or “ClientSide”.</p>
<p>Run the script on the client side.</p>
<blockquote>
<p>setupcert ClientSide</p>
</blockquote>
<p>You should now have a file in the current directory called ClientSide.publickey.cer. Copy this file over to the server side. You are now be able to install the client side cert on the server side.</p>
<p>Double click on the client side cert file. You should get a warning about the unknown provenance of the cert.</p>
<p><a href="%7Bstatic%7D2007/10/image1.png"><img src="%7Bstatic%7D2007/10/image-thumb1.png" alt="image">{width=&ldquo;428&rdquo; height=&ldquo;303&rdquo;}</a></p>
<p>Click the Open button. Then click on the ‘Install Certificate…’ button.</p>
<p><a href="%7Bstatic%7D2007/10/image2.png"><img src="%7Bstatic%7D2007/10/image-thumb2.png" alt="image">{width=&ldquo;300&rdquo; height=&ldquo;368&rdquo;}</a></p>
<p>You should now be running the certificate install wizard (or equivalent).</p>
<p><a href="%7Bstatic%7D2007/10/image3.png"><img src="%7Bstatic%7D2007/10/image-thumb3.png" alt="image">{width=&ldquo;364&rdquo; height=&ldquo;324&rdquo;}</a></p>
<p>Click Next. On the next page select to place the certificate in the store of your choice. A dialog box appears with the cert stores available. Check the ‘Show Physical Stores’ checkbox like so. Click OK to proceed.</p>
<p><a href="%7Bstatic%7D2007/10/image4.png"><img src="%7Bstatic%7D2007/10/image-thumb4.png" alt="image">{width=&ldquo;480&rdquo; height=&ldquo;345&rdquo;}</a></p>
<p>You will now get the confirmation window.</p>
<p><a href="%7Bstatic%7D2007/10/image5.png"><img src="%7Bstatic%7D2007/10/image-thumb5.png" alt="image">{width=&ldquo;392&rdquo; height=&ldquo;355&rdquo;}</a></p>
<p>Click Finish to complete the import. If all goes well you get this.</p>
<p><a href="%7Bstatic%7D2007/10/image6.png"><img src="%7Bstatic%7D2007/10/image-thumb6.png" alt="image">{width=&ldquo;285&rdquo; height=&ldquo;191&rdquo;}</a></p>
<p>At this stage we have a certificate installed on the client side called ClientSide. This certificate was copied to the server side and installed in the LocalMachine trusted people store. Now the reverse has to be done. Go to the server side and invoke the script from there.</p>
<blockquote>
<p>setupcert ServerSide</p>
</blockquote>
<p>copy ServerSide.publickey.cer to the client side, and from there you should repeat the import procedure outlined above. The certificates should now be configured. To confirm that, open mmc.exe and add a certificates snap-in for the local machine. On the client side you should see the ClientSide certificate in the personal certificates store.</p>
<p><a href="%7Bstatic%7D2007/10/image7.png"><img src="%7Bstatic%7D2007/10/image-thumb7.png" alt="image">{width=&ldquo;272&rdquo; height=&ldquo;289&rdquo;}</a></p>
<p>In the Trusted People certificates you should see the server side certificate.</p>
<p><a href="%7Bstatic%7D2007/10/image8.png"><img src="%7Bstatic%7D2007/10/image-thumb8.png" alt="image">{width=&ldquo;272&rdquo; height=&ldquo;289&rdquo;}</a></p>
<p>The reverse should be true for the Server side certificate stores.</p>
<h3 id="configuring-the-service-endpoints">Configuring the service endpoints</h3>
<p>The client side proxy needs to reference its certificate like so.</p>
<blockquote>
<pre><code>ServiceProxy proxy = new ServiceProxy();
SecurityHelper.SecureProxy&lt;IMyService&gt;(proxy, &quot;ClientSide&quot;);
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
</blockquote>
<p>And it can reference the server side certificate via the configuration settings.</p>
<pre><code>        &lt;endpoint
          address=&quot;http://nitrogen:8001/MyService&quot;
          binding=&quot;wsHttpBinding&quot;
          contract=&quot;SandlNtSvc.IMyService&quot;&gt;
          &lt;identity&gt;
            &lt;dns value=&quot;ServerSide&quot; /&gt;
          &lt;/identity&gt;
        &lt;/endpoint&gt;
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>The server side references its certificate via its security behavior attribute.</p>
<pre><code>    [SecurityBehavior(ServiceSecurity.Anonymous, &quot;ServerSide&quot;)]
    public class MyService : IMyService
    {
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>That&rsquo;s all the configuration needed for the service and proxy to talk to each other.</p>
<p>PS. remember to delete any cert files left lying around!</p>

    </article>

    


    <ul class="pager article-pager">
      <li class="pager-newer">
          <a href="/1/01/science-headlines-of-the-day/" data-toggle="tooltip" data-placement="top" title="Science Headlines of the Day">&lt; Newer</a>
      </li>
      <li class="pager-older">
        <a href="/1/01/self-modeling-robots/" data-toggle="tooltip" data-placement="top" title="Self Modeling Robots">Older &gt;</a>
      </li>
    </ul>
  </div>


<div class="site-footer">
  <div class="copyright">Andrew Matthews</div>
  <ul class="site-footer-items">
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a> and <a href="https://github.com/taikii/whiteplain">Whiteplain</a>
  </div>
</div>


</body>
</html>
