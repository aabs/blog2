<!DOCTYPE html>
<html lang="en-au">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>State Machines in C# 3.0 using T4 Templates | The Wandering Glitch</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="UPDATE: The original code for this post, that used to be available via a link on this page, is no longer available. I&rsquo;m afraid that if you want to try this one out, you&rsquo;ll have to piece it together using the snippets contained in this post. Sorry for the inconvenience - blame it on ISP churn.
 Some time back I wrote about techniques for implementing non-deterministic finite automata (NDFAs) using some of the new features of C# 3.">
    <meta name="generator" content="Hugo 0.92.2" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="State Machines in C# 3.0 using T4 Templates" />
<meta property="og:description" content="UPDATE: The original code for this post, that used to be available via a link on this page, is no longer available. I&rsquo;m afraid that if you want to try this one out, you&rsquo;ll have to piece it together using the snippets contained in this post. Sorry for the inconvenience - blame it on ISP churn.
 Some time back I wrote about techniques for implementing non-deterministic finite automata (NDFAs) using some of the new features of C# 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://45.89.107.9/posts/2008/state-machines-in-c-30-using-t4-templates/" /><meta property="article:section" content="posts" />



<meta itemprop="name" content="State Machines in C# 3.0 using T4 Templates">
<meta itemprop="description" content="UPDATE: The original code for this post, that used to be available via a link on this page, is no longer available. I&rsquo;m afraid that if you want to try this one out, you&rsquo;ll have to piece it together using the snippets contained in this post. Sorry for the inconvenience - blame it on ISP churn.
 Some time back I wrote about techniques for implementing non-deterministic finite automata (NDFAs) using some of the new features of C# 3.">

<meta itemprop="wordCount" content="1915">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="State Machines in C# 3.0 using T4 Templates"/>
<meta name="twitter:description" content="UPDATE: The original code for this post, that used to be available via a link on this page, is no longer available. I&rsquo;m afraid that if you want to try this one out, you&rsquo;ll have to piece it together using the snippets contained in this post. Sorry for the inconvenience - blame it on ISP churn.
 Some time back I wrote about techniques for implementing non-deterministic finite automata (NDFAs) using some of the new features of C# 3."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        The Wandering Glitch
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="Posts page">
              Posts
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
    
    <a href="https://twitter.com/aabs" target="_blank" rel="noopener" class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" aria-label="follow on Twitter——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
    
    <a href="https://github.com/aabs" target="_blank" rel="noopener" class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHub——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
    
    <a href="https://techhub.social/@aabs" target="_blank" rel="me noopener" class="mastadon ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="mastadon link" aria-label="follow on mastadon——Opens in a new window">
      
        mastadon
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
      
      <a href="https://twitter.com/share?url=http://45.89.107.9/posts/2008/state-machines-in-c-30-using-t4-templates/&amp;text=State%20Machines%20in%20C#%203.0%20using%20T4%20Templates" class="ananke-social-link twitter no-underline" aria-label="share on Twitter">
        
        <span class="icon"> <svg style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>
</span>
        
      </a>
    
  </div>


      <h1 class="f1 athelas mt3 mb1">State Machines in C# 3.0 using T4 Templates</h1>
      
      <p class="tracked">
        By <strong>aabs</strong>
      </p>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links #000000 pr4-l w-two-thirds-l"><p><strong>UPDATE</strong>: The original code for this post, that used to be available via a link on this page, is no longer available. I&rsquo;m afraid that if you want to try this one out, you&rsquo;ll have to piece it together using the snippets contained in this post. Sorry for the inconvenience - blame it on ISP churn.</p>
<hr>
<p>Some time back I <a href="http://aabs.wordpress.com/2007/01/16/342/">wrote</a> about techniques for implementing non-deterministic finite automata (NDFAs) using some of the new features of C# 3.0. Recently I&rsquo;ve had a need to revisit that work to provide a client with a means to generate a bunch of really complex state machines in a lightweight, extensible and easily understood model. VS 2008 and C# 3.0 are pretty much the perfect platform for the job - they combine partial classes and methods, lambda functions and T4 templates making it a total walk in the park. This post will look at the prototype system I put together. This is a very code intensive post - sorry about that, but it&rsquo;s late and apparently my eyes are very red, puffy and panda like.</p>
<p>State machines are the core of many applications - yet we often find people hand coding them with nested switch statements and grizzly mixtures of state control and business logic. It&rsquo;s a nightmare scenario making code completely unmaintainable for anything but the most trivial applications.</p>
<p>The key objective for a dedicated application framework that manages a state machine is to provide a clean way to break out the code that manages the state machine from the code that implements the activities performed as part of the state machine. C# 3.0 has a nice solution for this - partial types and methods.</p>
<h3 id="partial-types-and-methods">Partial types and methods</h3>
<p>A partial type is a type whose definition is not confined to a single code module - it can have multiple modules. Some of those can be written by you, others can be written by a code generator. Here&rsquo;s an example of a partial class definition:</p>
<pre><code>public partial class MyPartialClass{}
</code></pre>
<p>By by declaring the class to be partial, you say that other files may contain parts of the class definition. the point of this kind of structure is that you might have piece of code that you want to write by hand, and others that you want to have driven from a code generator, stuff that gets overwritten every time the generator runs. If your code got erased every time you ran the generator, you&rsquo;d get bored very quickly. You need a way to chop out the bits that don&rsquo;t change. Typically, these will be framework or infrastructure stuff.</p>
<p>Partial classes can also have partial methods. Partial methods allow you to define a method signature in case someone wants to define it in another part of the partial class. This might seem pointless, but wait and see - it&rsquo;s nice. Here&rsquo;s how you declare a partial method:</p>
<pre><code>// the code generated part public partial class MyPartialClass {
    partial void DoIt(int x);
}
</code></pre>
<p>You can then implement it in another file like so:</p>
<pre><code>// the hand-written part partial class MyPartialClass {
    partial void DoIt(int x)
    {
        throw new NotImplementedException();
    }
}
</code></pre>
<p>This is all a little abstract, right now, so let&rsquo;s see how we can use this to implement a state machine framework. First we need a way to define a state machine. I&rsquo;m going to use a simple XML file for this:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt; &lt;StateModels&gt; &lt;StateModel ID=&quot;My&quot; start=&quot;defcon1&quot;&gt; &lt;States&gt; &lt;State ID=&quot;defcon1&quot; name=&quot;defcon1&quot;/&gt; &lt;State ID=&quot;defcon2&quot; name=&quot;defcon2&quot;/&gt; &lt;State ID=&quot;defcon3&quot; name=&quot;defcon3&quot;/&gt; &lt;/States&gt; &lt;Inputs&gt; &lt;Input ID=&quot;diplomaticIncident&quot; name=&quot;diplomaticIncident&quot;/&gt; &lt;Input ID=&quot;assassination&quot; name=&quot;assassination&quot;/&gt; &lt;Input ID=&quot;coup&quot; name=&quot;coup&quot;/&gt; &lt;/Inputs&gt; &lt;Transitions&gt; &lt;Transition from=&quot;defcon1&quot; to=&quot;defcon2&quot; on=&quot;diplomaticIncident&quot;/&gt; &lt;Transition from=&quot;defcon2&quot; to=&quot;defcon3&quot; on=&quot;assassination&quot;/&gt; &lt;Transition from=&quot;defcon3&quot; to=&quot;defcon1&quot; on=&quot;coup&quot;/&gt; &lt;/Transitions&gt; &lt;/StateModel&gt; &lt;/StateModels&gt;
</code></pre>
<p>Here we have a really simple state machine with three states (defcon1, defcon2 and defcon3) as well as three kinds of input (diplomaticIncident, assassination and coup). Please excuse the militarism - I just finished watching a season of 24, so I&rsquo;m all hyped up. This simple model also defines three transitions. it creates a model like this:</p>
<p>Microsoft released the Text Template Transformation Toolkit (T4) system with Visual Studio 2008. This toolkit has been part of GAT and DSL tools in the past, but this is the first time that it has been available by default in VS. It allows an ASP.NET syntax for defining templates. Here&rsquo;s a snippet from the T4 template that generates the state machine:</p>
<pre><code>&lt;#@ template language=&quot;C#&quot; #&gt;
&lt;#@ assembly name=&quot;System.Xml.dll&quot; #&gt;
&lt;#@ import namespace=&quot;System.Xml&quot; #&gt;

&lt;#
    XmlDocument doc = new XmlDocument();
    doc.Load(@&quot;TestHarness\model.xml&quot;);
    XmlElement xnModel = (XmlElement)doc.SelectSingleNode(&quot;/StateModels/StateModel&quot;);
    string ns = xnModel.GetAttribute(&quot;ID&quot;);
    XmlNodeList states = xnModel.SelectNodes(&quot;descendant::State&quot;);
    XmlNodeList inputs = xnModel.SelectNodes(&quot;descendant::Input&quot;);
    XmlNodeList trns = xnModel.SelectNodes(&quot;descendant::Transition&quot;);
    #&gt;
using System;
using System.Collections.Generic;

namespace &lt;#=ns#&gt; {
public enum &lt;#=ns#&gt;States : int{
&lt;#
string sep = &quot;&quot;;
foreach(XmlElement s in states)
    {
    Write(sep + s.GetAttribute(&quot;ID&quot;));
    WriteLine(@&quot;// &quot; + s.GetAttribute(&quot;name&quot;));
    sep = &quot;,&quot;;
    }

#&gt;
} // end enum &lt;#=ns#&gt;States

public enum &lt;#=ns#&gt;Inputs : int{
&lt;#
sep = &quot;&quot;;
foreach(XmlElement s in inputs)
    {
    Write(sep + s.GetAttribute(&quot;ID&quot;));
    WriteLine(@&quot;// &quot; + s.GetAttribute(&quot;name&quot;));
    sep = &quot;,&quot;;
    }

#&gt;
} // end enum &lt;#=ns#&gt;States

public partial class &lt;#=ns#&gt;StateModel{

        public &lt;#=ns#&gt;StateModel()
        {
            SetupStates();
            SetupTransitions();
            SetStartState();
        }
...
</code></pre>
<p>Naturally, there&rsquo;s a lot in the template, but we&rsquo;ll get to that later. First we need a representation of a state. You&rsquo;ll see from the template that an enum get&rsquo;s generated called &lt;#=ns#&gt;States. Here&rsquo;s what it looks like for the defcon model.</p>
<pre><code>public enum MyStates : int {
defcon1// defcon1 ,defcon2// defcon2 ,defcon3// defcon3 } // end enum MyStates
</code></pre>
<p>This is still a bit too bare for my liking. I can&rsquo;t attach an event model to these states, so here&rsquo;s a class that can carry around one of these values:</p>
<pre><code>public class State {
    public int Identifier { get; set; }
public delegate void OnEntryEventHandler(object sender, OnEntryEventArgs e);
    // ...public event OnEntryEventHandler OnEntryEvent;
    // ...}
</code></pre>
<p>There&rsquo;s a lot left out of this, but the point is that as well as storing an identifier for a state, it has events for both entry into and exit from the state. This can be used by the event framework of the state machine to provide hooks for your custom state transition and entry code. The same model is used for transitions:</p>
<pre><code>public class StateTransition {
    public State FromState { get; set; }
    public State ToState { get; set; }
public event OnStateTransitioningEventHandler OnStateTransitioningEvent;
public event OnStateTransitionedEventHandler OnStateTransitionedEvent;
}
</code></pre>
<p>Here&rsquo;s the list of inputs that can trigger a transition between states:</p>
<pre><code>public enum MyInputs : int {
diplomaticIncident// diplomaticIncident ,assassination// assassination ,coup// coup } // end enum MyStates
</code></pre>
<p>The template helps to define storage for the states and transitions of the model:</p>
<pre><code>public static Dictionary&lt;&lt;#= ns#&gt;States, State&gt; states                = new Dictionary&lt;&lt;#= ns#&gt;States, State&gt;();
public static Dictionary&lt;string, StateTransition&gt; arcs                = new Dictionary&lt;string, StateTransition&gt;();
public State CurrentState { get; set; }
</code></pre>
<p>which for the model earlier, will yield the following:</p>
<pre><code>public static Dictionary&lt;MyStates, State&gt; states = new Dictionary&lt;MyStates, State&gt;();
public static Dictionary&lt;string, StateTransition&gt; arcs = new Dictionary&lt;string, StateTransition&gt;();
public State CurrentState { get; set; }
</code></pre>
<p>Now we can create entries in these tables for the transitions in the model:</p>
<pre><code>private void SetStartState()
{
    CurrentState = states[&lt;#= ns#&gt;States.&lt;#=xnModel.GetAttribute(&quot;start&quot;)#&gt;];
}

private void SetupStates()
{
&lt;#
foreach(XmlElement s in states)
    {
    WriteLine(&quot;states[&quot; + ns + &quot;States.&quot;+s.GetAttribute(&quot;ID&quot;)+&quot;] =               new State { Identifier = (int)&quot;+ns+&quot;States.&quot;+s.GetAttribute(&quot;ID&quot;)+&quot; };&quot;);
    WriteLine(&quot;states[&quot; + ns + &quot;States.&quot;+s.GetAttribute(&quot;ID&quot;)+&quot;].OnEntryEvent               += (x, y) =&gt; OnEnter_&quot;+s.GetAttribute(&quot;ID&quot;)+&quot;();&quot;);
    WriteLine(&quot;states[&quot; + ns + &quot;States.&quot;+s.GetAttribute(&quot;ID&quot;)+&quot;].OnExitEvent               += (x, y) =&gt; OnLeave_&quot;+s.GetAttribute(&quot;ID&quot;)+&quot;(); ;&quot;);
    }
#&gt;
}
private void SetupTransitions()
{
&lt;#
foreach(XmlElement s in trns)
    {
    #&gt;
    arcs[&quot;&lt;#=s.GetAttribute(&quot;from&quot;)#&gt;_&lt;#=s.GetAttribute(&quot;on&quot;)#&gt;&quot;] = new StateTransition
    {
        FromState = states[&lt;#= ns#&gt;States.&lt;#=s.GetAttribute(&quot;from&quot;)#&gt;],
        ToState = states[&lt;#= ns#&gt;States.&lt;#=s.GetAttribute(&quot;to&quot;)#&gt;]
    };
    arcs[&quot;&lt;#=s.GetAttribute(&quot;from&quot;)#&gt;_&lt;#=s.GetAttribute(&quot;on&quot;)#&gt;&quot;].OnStateTransitioningEvent              += (x,y)=&gt;MovingFrom_&lt;#=s.GetAttribute(&quot;from&quot;)#&gt;_To_&lt;#=s.GetAttribute(&quot;to&quot;)#&gt;;
    arcs[&quot;&lt;#=s.GetAttribute(&quot;from&quot;)#&gt;_&lt;#=s.GetAttribute(&quot;on&quot;)#&gt;&quot;].OnStateTransitionedEvent              += (x,y)=&gt;MovedFrom_&lt;#=s.GetAttribute(&quot;from&quot;)#&gt;_To_&lt;#=s.GetAttribute(&quot;to&quot;)#&gt;;
    &lt;#
    }
    #&gt;
}
</code></pre>
<p>which is where the fun starts. First notice that we create a new state for each state in the model and attach a lambda to the entry and exit events of each state. For our model that would look like this:</p>
<pre><code>private void SetupStates()
{
    states[MyStates.defcon1] = new State {Identifier = (int) MyStates.defcon1};
    states[MyStates.defcon1].OnEntryEvent += (x, y) =&gt; OnEnter_defcon1();
    states[MyStates.defcon1].OnExitEvent += (x, y) =&gt; OnLeave_defcon1();

    states[MyStates.defcon2] = new State {Identifier = (int) MyStates.defcon2};
    states[MyStates.defcon2].OnEntryEvent += (x, y) =&gt; OnEnter_defcon2();
    states[MyStates.defcon2].OnExitEvent += (x, y) =&gt; OnLeave_defcon2();

    states[MyStates.defcon3] = new State {Identifier = (int) MyStates.defcon3};
    states[MyStates.defcon3].OnEntryEvent += (x, y) =&gt; OnEnter_defcon3();
    states[MyStates.defcon3].OnExitEvent += (x, y) =&gt; OnLeave_defcon3();
}
</code></pre>
<p>For the Transitions the same sort of code gets generated, except that we have some simple work to generate a string key for a specific &lt;state, input&gt; pair. Here&rsquo;s what comes out:</p>
<pre><code>private void SetupTransitions()
{
    arcs[&quot;defcon1_diplomaticIncident&quot;] = new StateTransition {
                 FromState = states[MyStates.defcon1],
                 ToState = states[MyStates.defcon2]
             };
    arcs[&quot;defcon1_diplomaticIncident&quot;].OnStateTransitioningEvent                  += (x, y) =&gt; MovingFrom_defcon1_To_defcon2;
    arcs[&quot;defcon1_diplomaticIncident&quot;].OnStateTransitionedEvent                 += (x, y) =&gt; MovedFrom_defcon1_To_defcon2;
    arcs[&quot;defcon2_assassination&quot;] = new StateTransition {
                 FromState = states[MyStates.defcon2],
                 ToState = states[MyStates.defcon3]
            };
    arcs[&quot;defcon2_assassination&quot;].OnStateTransitioningEvent                += (x, y) =&gt; MovingFrom_defcon2_To_defcon3;
    arcs[&quot;defcon2_assassination&quot;].OnStateTransitionedEvent                += (x, y) =&gt; MovedFrom_defcon2_To_defcon3;
    arcs[&quot;defcon3_coup&quot;] = new StateTransition {
                 FromState = states[MyStates.defcon3],
                 ToState = states[MyStates.defcon1]
           };
    arcs[&quot;defcon3_coup&quot;].OnStateTransitioningEvent                += (x, y) =&gt; MovingFrom_defcon3_To_defcon1;
    arcs[&quot;defcon3_coup&quot;].OnStateTransitionedEvent                += (x, y) =&gt; MovedFrom_defcon3_To_defcon1;
}
</code></pre>
<p>You can see that for each state and transition event I&rsquo;m adding lambdas that invoke methods that are also being code generated. these are the partial methods described earlier. Here&rsquo;s the generator:</p>
<pre><code>foreach(XmlElement s in states)
    {
    WriteLine(&quot;partial void OnLeave_&quot;+s.GetAttribute(&quot;ID&quot;)+&quot;();&quot;);
    WriteLine(&quot;partial void OnEnter_&quot;+s.GetAttribute(&quot;ID&quot;)+&quot;();&quot;);
    }
foreach(XmlElement s in trns)
    {
    WriteLine(&quot;partial void MovingFrom_&quot;+s.GetAttribute(&quot;from&quot;)+&quot;_To_&quot;+s.GetAttribute(&quot;to&quot;)+&quot;();&quot;);
    WriteLine(&quot;partial void MovedFrom_&quot;+s.GetAttribute(&quot;from&quot;)+&quot;_To_&quot;+s.GetAttribute(&quot;to&quot;)+&quot;();&quot;);
    }
</code></pre>
<p>Which gives us:</p>
<pre><code>partial void OnLeave_defcon1();
partial void OnEnter_defcon1();
partial void OnLeave_defcon2();
partial void OnEnter_defcon2();
partial void OnLeave_defcon3();
partial void OnEnter_defcon3();
partial void MovingFrom_defcon1_To_defcon2();
partial void MovedFrom_defcon1_To_defcon2();
partial void MovingFrom_defcon2_To_defcon3();
partial void MovedFrom_defcon2_To_defcon3();
partial void MovingFrom_defcon3_To_defcon1();
partial void MovedFrom_defcon3_To_defcon1();
</code></pre>
<p>The C# 3.0 spec states that if you don&rsquo;t choose to implement one of these partial methods then the effect is similar to attaching a ConditionalAttribute to it - it gets taken out and no trace is left of it ever having been declared. That&rsquo;s nice, because for some state models you may not want to do anything other than make the transition.</p>
<p>We now have a working state machine with masses of extensibility points that we can use as we see fit. Say we decided to implement a few of these methods like so:</p>
<pre><code>public partial class MyStateModel {
    partial void OnEnter_defcon1()
    {
        Debug.WriteLine(&quot;Going Into defcon1.&quot;);
    }
    partial void OnEnter_defcon2()
    {
        Debug.WriteLine(&quot;Going Into defcon2.&quot;);
    }
    partial void OnEnter_defcon3()
    {
        Debug.WriteLine(&quot;Going Into defcon3.&quot;);
    }
}
</code></pre>
<p>Here&rsquo;s how you&rsquo;d invoke it:</p>
<pre><code>MyStateModel dfa = new MyStateModel();
dfa.ProcessInput((int) MyInputs.diplomaticIncident);
dfa.ProcessInput((int) MyInputs.assassination);
dfa.ProcessInput((int) MyInputs.coup);
</code></pre>
<p>And here&rsquo;s what you&rsquo;d get:</p>
<pre><code>Going Into defcon2.
Going Into defcon3.
Going Into defcon1.
</code></pre>
<p>There&rsquo;s a lot you can do to improve the model I&rsquo;ve presented (like passing context info into the event handlers, and allowing some of the event handlers to veto state transitions). But I hope that it shows how the partials support in conjunction with T4 templates makes light work of this perennial problem. This could easily save you from writing thousands of lines of tedious and error prone boiler plate code. That for me is a complete no-brainer.</p>
<p>What I like about this model is the ease with which I was able to get code generation. I just added a file with extension &lsquo;.tt&rsquo; to VS 2008 and it immediately started generating C# from it. All I needed to do at that point was load up my XML file and feed it into the template. I like the fact that the system is lightweight. There is not a mass of framework that takes over the state management, it&rsquo;s infinitely extensible, and it allows a very quick turnaround time on state model changes.</p>
<p>What do you think? How would you tackle this problem?</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://45.89.107.9/" >
    &copy;  The Wandering Glitch 2022 
  </a>
    <div>
<div class="ananke-socials">
  
    
    <a href="https://twitter.com/aabs" target="_blank" rel="noopener" class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" aria-label="follow on Twitter——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
    
    <a href="https://github.com/aabs" target="_blank" rel="noopener" class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHub——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
    
    <a href="https://techhub.social/@aabs" target="_blank" rel="me noopener" class="mastadon ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="mastadon link" aria-label="follow on mastadon——Opens in a new window">
      
        mastadon
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
