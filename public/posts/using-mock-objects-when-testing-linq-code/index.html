<!DOCTYPE html>
<html lang="en-au">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Using Mock Objects When Testing LINQ Code | The Wandering Glitch</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="I was wondering the other day whether LINQ could be used with NMock easily. One problem with testing code that has not been written to work with unit tests is that if you test business logic, you often end up making multiple round-trips to the database for each test run. With a very large test suite that can turn a few minute&rsquo;s work into hours for a test suite. the best approach to this is to use mock data access components to dispense canned results, rather than going all the way through to the database.">
    <meta name="generator" content="Hugo 0.92.2" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="Using Mock Objects When Testing LINQ Code" />
<meta property="og:description" content="I was wondering the other day whether LINQ could be used with NMock easily. One problem with testing code that has not been written to work with unit tests is that if you test business logic, you often end up making multiple round-trips to the database for each test run. With a very large test suite that can turn a few minute&rsquo;s work into hours for a test suite. the best approach to this is to use mock data access components to dispense canned results, rather than going all the way through to the database." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://45.89.107.9/posts/using-mock-objects-when-testing-linq-code/" /><meta property="article:section" content="posts" />



<meta itemprop="name" content="Using Mock Objects When Testing LINQ Code">
<meta itemprop="description" content="I was wondering the other day whether LINQ could be used with NMock easily. One problem with testing code that has not been written to work with unit tests is that if you test business logic, you often end up making multiple round-trips to the database for each test run. With a very large test suite that can turn a few minute&rsquo;s work into hours for a test suite. the best approach to this is to use mock data access components to dispense canned results, rather than going all the way through to the database.">

<meta itemprop="wordCount" content="1044">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using Mock Objects When Testing LINQ Code"/>
<meta name="twitter:description" content="I was wondering the other day whether LINQ could be used with NMock easily. One problem with testing code that has not been written to work with unit tests is that if you test business logic, you often end up making multiple round-trips to the database for each test run. With a very large test suite that can turn a few minute&rsquo;s work into hours for a test suite. the best approach to this is to use mock data access components to dispense canned results, rather than going all the way through to the database."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        The Wandering Glitch
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="Posts page">
              Posts
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
    
    <a href="https://techhub.social/@aabs" target="_blank" rel="me noopener" class="mastodon ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Mastodon link" aria-label="follow on Mastodon——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 230 230;" version="1.1" viewBox="0 0 230 230"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<path d="M211.80683 139.0875c-3.1825 16.36625-28.4925 34.2775-57.5625 37.74875-15.16 1.80875-30.0825 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125 0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.3925 27.9425 21.115.7225 39.91625-5.20625 39.91625-5.20625l.86875 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23183 213.82 1.40558 165.31125.20808 116.09125c-.36375-14.61375-.14-28.39375-.14-39.91875 0-50.33 32.97625-65.0825 32.97625-65.0825C49.67058 3.45375 78.20308.2425 107.86433 0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09 0 0 32.97625 14.7525 32.97625 65.0825 0 0 .4125 37.13375-4.6 62.915" style="fill-rule:evenodd;clip-rule:evenodd;"/>
<path d="M65.68743 96.45938c0 9.01375-7.3075 16.32125-16.3225 16.32125-9.01375 0-16.32-7.3075-16.32-16.32125 0-9.01375 7.30625-16.3225 16.32-16.3225 9.015 0 16.3225 7.30875 16.3225 16.3225M124.52893 96.45938c0 9.01375-7.30875 16.32125-16.3225 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.3225 7.30875 16.3225 16.3225M183.36933 96.45938c0 9.01375-7.3075 16.32125-16.32125 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.32125 7.30875 16.32125 16.3225" fill="#fff"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Using Mock Objects When Testing LINQ Code</h1>
      
      <p class="tracked">
        By <strong>aabs</strong>
      </p>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links #000000 pr4-l w-two-thirds-l"><p>I was wondering the other day whether LINQ could be used with NMock easily. One problem with testing code that has not been written to work with unit tests is that if you test business logic, you often end up making multiple round-trips to the database for each test run. With a very large test suite that can turn a few minute&rsquo;s work into hours for a test suite. the best approach to this is to use mock data access components to dispense canned results, rather than going all the way through to the database.</p>
<p>After a little thought it became clear that all you have to do is override the <em><strong>IOrderedQueryable&lt;T&gt;.GetEnumerator()</strong></em> method to return an enumerator to a set of canned results and you could pretty much impersonate a LINQ to SQL Table (which is the <em><strong>IOrderedQueryable</strong></em> implementation for LINQ to SQL). I had a spare few minutes the other day while the kids were going to sleep and I decided to give it a go, to see what was involved.</p>
<p>I&rsquo;m a great believer in the medicinal uses of mock objects. Making your classes testable using mocking enforces a level of encapsulation that adds good structure to your code. I find that the end results are often much cleaner if you design your systems with mocking in mind.</p>
<p>Lets start with a class that you were querying over in your code. This is the type that you are expecting to get back from your query.</p>
<pre><code>public class MyEntity
{
    public string Name
    {
        get { return name; }
        set { name = value; }
    }

    public int Age
    {
        get { return age; }
        set { age = value; }
    }

    public string Desc
    {
        get { return desc; }
        set { desc = value; }
    }

    private string name;
    private int age;
    private string desc;
}
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Now you need to create a new context object derived from the DLINQ <em><strong>DataContext</strong></em> class, but providing a new constructor function. You can create other ways to insert the data you want your query to return, but the constructor is all that is necessary for this simple example.</p>
<pre><code>public class MockContext : DataContext
{
    #region constructors

    public MockContext(IEnumerable col):base(&quot;&quot;)
    {
        User = new MockQuery&lt;MyEntity&gt;(col);
    }
    // other constructors removed for readability
    #endregion
    public MockQuery&lt;MyEntity&gt; User;
}
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Note that you are passing in an untyped <em><strong>IEnumerable</strong></em> rather than an <em><strong>IEnumerable&lt;T&gt;</strong></em> or a concrete collection class. The reason is that when you make use of projections in LINQ, the type gets transformed along the way. Consider the following:</p>
<pre><code>var q = from u in db.User
        where u.Name.Contains(&quot;Andrew&quot;) &amp;&amp; u.Age &lt; 40
        select new {u.Age};
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>The result of <em><strong>db.User</strong></em> is an <em><strong>IOrderedQueryable&lt;User&gt;</strong></em> query class which is derived from <em><strong>IEnumerable&lt;User&gt;</strong></em>. But the result that goes into <em><strong>q</strong></em> is an <em><strong>IEnumerable</strong></em> of some anonymous type created specially for the occasion. there is a step along the way when the <em><strong>IQueryable&lt;User&gt;</strong></em> gets replaced with an <em><strong>IQueryable&lt;AnonType&gt;</strong></em>. If I set the type on the enumerator of the canned results, I would have to keep track of them with each call to <em><strong>CreateQuery</strong></em> in my Mock Query class. By using <em><strong>IEnumerable</strong></em>, I can just pass it around till I need it, then just enumerate the collection with a custom iterator, casting the types to what I ultimately need as I go.</p>
<p>The query object also has a constructor that takes an <em><strong>IEnumerable</strong></em>, and it keeps that till <em><strong>GetEnumerator()</strong></em> gets called later on. <em><strong>CreateQuery</strong></em> and <em><strong>CloneQueryForNewType</strong></em> just pass the <em><strong>IEnumerable</strong></em> around till the time is right. <em><strong>GetEnumerator</strong></em> just iterates the collection in the <em><strong>cannedResponse</strong></em> iterator casting them to the return type expected for the resulting query.</p>
<pre><code>public class MockQuery&lt;T&gt; : IOrderedQueryable&lt;T&gt;
{
    private readonly IEnumerable cannedResponse;

    public MockQuery(IEnumerable cannedResponse)
    {
        this.cannedResponse = cannedResponse;
    }

    private Expression expression;
    private Type elementType;

    #region IQueryable&lt;T&gt; Members

    IQueryable&lt;S&gt; IQueryable&lt;T&gt;.CreateQuery&lt;S&gt;(Expression expression)
    {
        MockQuery&lt;S&gt; newQuery = CloneQueryForNewType&lt;S&gt;();
        newQuery.expression = expression;
        return newQuery;
    }

    private MockQuery&lt;S&gt; CloneQueryForNewType&lt;S&gt;()
    {
        return new MockQuery&lt;S&gt;(cannedResponse);
    }
    #endregion

    #region IEnumerable&lt;T&gt; Members
    IEnumerator&lt;T&gt; IEnumerable&lt;T&gt;.GetEnumerator()
    {
        foreach (T t in cannedResponse)
        {
            yield return t;
        }
    }
    #endregion

    #region IQueryable Members
    Expression IQueryable.Expression
    {
        get { return System.Expressions.Expression.Constant(this); }
    }

    Type IQueryable.ElementType
    {
        get { return elementType; }
    }
    #endregion
}
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>For the sake of readability I have left out the required interface methods that were not implemented, since they play no part in this solution. Now lets look at a little test harness:</p>
<pre><code>class Program
{
    static void Main(string[] args)
    {
        MockContext db = new MockContext(GetMockResults());

        var q = from u in db.User
                where u.Name.Contains(&quot;Andrew&quot;) &amp;&amp; u.Age &lt; 40
                select u;
        foreach (MyEntity u in q)
        {
            Debug.WriteLine(string.Format(&quot;entity {0}, {1}, {2}&quot;, u.Name, u.Age, u.Desc));
        }
    }

    private static IEnumerable GetMockResults()
    {
        for (int i = 0; i &lt; 20; i++)
        {
            MyEntity r = new MyEntity();
            r.Name = &quot;name &quot; + i;
            r.Age = 30 + i;
            r.Desc = &quot;desc &quot; + i;
            yield return r;
        }
    }
}
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>The only intrusion here is the explicit use of <em><strong>MockContext</strong></em>. In the production code that is to be tested, you can&rsquo;t just go inserting <em><strong>MockContext</strong></em> where you would have used the SqlMetal generated context. You need to use a class factory that will allow you to provide the <em><strong>MockContext</strong></em> on demand in a unit test, but dispense a true LINQ to SQL context when in production. That way, all client code will just use mock data without knowing it.</p>
<p>Here&rsquo;s the pattern that I generally follow. I got it from the Java community, but I can&rsquo;t remember where:</p>
<pre><code>class DbContextClassFactory
{
    class Environment
    {
        private static bool inUnitTest = false;

        public static bool InUnitTest
        {
            get { return Environment.inUnitTest; }
            set { Environment.inUnitTest = value; }
        }
        private static DataContext objectToDispense = null;

        public static DataContext ObjectToDispense
        {
            get { return Environment.objectToDispense; }
            set { Environment.objectToDispense = value; }
        }
    }

    public object GetDB()
    {
        if (Environment.InUnitTest)
            return Environment.ObjectToDispense;
        return new TheRealContext() as DataContext;
    }
}
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Now you can create your query like this:</p>
<pre><code>DbContextClassFactory.Environment.ObjectToDispense = new MockContext(GetMockResults());
var q = from u in DbContextClassFactory.GetDB() where ...
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>And your client code will use the <em><strong>MockContext</strong></em> if there is one, otherwise it will use a LINQ to SQL context to talk to the real database. Perhaps we should call this <em>Mockeries</em> rather than Mock Queries. What do you think?</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://45.89.107.9/" >
    &copy;  The Wandering Glitch 2022 
  </a>
    <div>
<div class="ananke-socials">
  
    
    <a href="https://techhub.social/@aabs" target="_blank" rel="me noopener" class="mastodon ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Mastodon link" aria-label="follow on Mastodon——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 230 230;" version="1.1" viewBox="0 0 230 230"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<path d="M211.80683 139.0875c-3.1825 16.36625-28.4925 34.2775-57.5625 37.74875-15.16 1.80875-30.0825 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125 0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.3925 27.9425 21.115.7225 39.91625-5.20625 39.91625-5.20625l.86875 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23183 213.82 1.40558 165.31125.20808 116.09125c-.36375-14.61375-.14-28.39375-.14-39.91875 0-50.33 32.97625-65.0825 32.97625-65.0825C49.67058 3.45375 78.20308.2425 107.86433 0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09 0 0 32.97625 14.7525 32.97625 65.0825 0 0 .4125 37.13375-4.6 62.915" style="fill-rule:evenodd;clip-rule:evenodd;"/>
<path d="M65.68743 96.45938c0 9.01375-7.3075 16.32125-16.3225 16.32125-9.01375 0-16.32-7.3075-16.32-16.32125 0-9.01375 7.30625-16.3225 16.32-16.3225 9.015 0 16.3225 7.30875 16.3225 16.3225M124.52893 96.45938c0 9.01375-7.30875 16.32125-16.3225 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.3225 7.30875 16.3225 16.3225M183.36933 96.45938c0 9.01375-7.3075 16.32125-16.32125 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.32125 7.30875 16.32125 16.3225" fill="#fff"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
