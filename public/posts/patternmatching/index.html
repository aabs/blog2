<!DOCTYPE html>
<html lang="en-au">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Pattern Matching in C# | The Wandering Glitch</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="I recently used Matthew Podwyszocki&rsquo;s pattern matching classes for a top level exception handler in an App I&rsquo;m writing. Matthew&rsquo;s classes are a really nice fluent interface attaching predicates to functions generating results. I used it as a class factory to select between handlers for exceptions. Here&rsquo;s an example of how I used it:
ExceptionHandler handler = ex.Match() // . . . .With(e =&gt; e.GetType().Equals(typeof(SoapException)), e=&gt; new ReallocateEndpointHandler() as ExceptionHandler) .">
    <meta name="generator" content="Hugo 0.92.2" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="Pattern Matching in C#" />
<meta property="og:description" content="I recently used Matthew Podwyszocki&rsquo;s pattern matching classes for a top level exception handler in an App I&rsquo;m writing. Matthew&rsquo;s classes are a really nice fluent interface attaching predicates to functions generating results. I used it as a class factory to select between handlers for exceptions. Here&rsquo;s an example of how I used it:
ExceptionHandler handler = ex.Match() // . . . .With(e =&gt; e.GetType().Equals(typeof(SoapException)), e=&gt; new ReallocateEndpointHandler() as ExceptionHandler) ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://45.89.107.9/posts/patternmatching/" /><meta property="article:section" content="posts" />



<meta itemprop="name" content="Pattern Matching in C#">
<meta itemprop="description" content="I recently used Matthew Podwyszocki&rsquo;s pattern matching classes for a top level exception handler in an App I&rsquo;m writing. Matthew&rsquo;s classes are a really nice fluent interface attaching predicates to functions generating results. I used it as a class factory to select between handlers for exceptions. Here&rsquo;s an example of how I used it:
ExceptionHandler handler = ex.Match() // . . . .With(e =&gt; e.GetType().Equals(typeof(SoapException)), e=&gt; new ReallocateEndpointHandler() as ExceptionHandler) .">

<meta itemprop="wordCount" content="621">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Pattern Matching in C#"/>
<meta name="twitter:description" content="I recently used Matthew Podwyszocki&rsquo;s pattern matching classes for a top level exception handler in an App I&rsquo;m writing. Matthew&rsquo;s classes are a really nice fluent interface attaching predicates to functions generating results. I used it as a class factory to select between handlers for exceptions. Here&rsquo;s an example of how I used it:
ExceptionHandler handler = ex.Match() // . . . .With(e =&gt; e.GetType().Equals(typeof(SoapException)), e=&gt; new ReallocateEndpointHandler() as ExceptionHandler) ."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        The Wandering Glitch
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="Posts page">
              Posts
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
    
    <a href="https://techhub.social/@aabs" target="_blank" rel="me noopener" class="mastodon ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Mastodon link" aria-label="follow on Mastodon——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 230 230;" version="1.1" viewBox="0 0 230 230"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<path d="M211.80683 139.0875c-3.1825 16.36625-28.4925 34.2775-57.5625 37.74875-15.16 1.80875-30.0825 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125 0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.3925 27.9425 21.115.7225 39.91625-5.20625 39.91625-5.20625l.86875 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23183 213.82 1.40558 165.31125.20808 116.09125c-.36375-14.61375-.14-28.39375-.14-39.91875 0-50.33 32.97625-65.0825 32.97625-65.0825C49.67058 3.45375 78.20308.2425 107.86433 0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09 0 0 32.97625 14.7525 32.97625 65.0825 0 0 .4125 37.13375-4.6 62.915" style="fill-rule:evenodd;clip-rule:evenodd;"/>
<path d="M65.68743 96.45938c0 9.01375-7.3075 16.32125-16.3225 16.32125-9.01375 0-16.32-7.3075-16.32-16.32125 0-9.01375 7.30625-16.3225 16.32-16.3225 9.015 0 16.3225 7.30875 16.3225 16.3225M124.52893 96.45938c0 9.01375-7.30875 16.32125-16.3225 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.3225 7.30875 16.3225 16.3225M183.36933 96.45938c0 9.01375-7.3075 16.32125-16.32125 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.32125 7.30875 16.32125 16.3225" fill="#fff"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Pattern Matching in C#</h1>
      
      <p class="tracked">
        By <strong>aabs</strong>
      </p>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links #000000 pr4-l w-two-thirds-l"><p>I recently used Matthew Podwyszocki&rsquo;s <a href="http://weblogs.asp.net/podwysocki/archive/2008/09/16/functional-c-pattern-matching.aspx">pattern matching</a> classes for a top level exception handler in an App I&rsquo;m writing. Matthew&rsquo;s classes are a really nice fluent interface attaching predicates to functions generating results. I used it as a class factory to select between handlers for exceptions. Here&rsquo;s an example of how I used it:</p>
<pre><code>ExceptionHandler handler = ex.Match()
    // . . .
    .With(e =&gt; e.GetType().Equals(typeof(SoapException)),
             e=&gt; new ReallocateEndpointHandler() as ExceptionHandler)
    .With(e =&gt; e.Message.Contains(&quot;Could not acquire agent object.&quot;),
             e =&gt; new CleanupSessionHandler() as ExceptionHandler)
    // . . .
    .Else(e=&gt;new ExceptionSwallowingHandler() as ExceptionHandler)
    .Do();
</code></pre>
<p>Clearly a very useful API to provide complex pattern matching against a value. It has two drawbacks that prevented me from using it to do health checking and validation: caching of the pattern matcher and parameterisation of the function with incomming values. You use the above handler on a given value &lsquo;ex&rsquo; in a catch block. I have a whole SOAP API that I&rsquo;m working with that can return similar exceptions, so presently I&rsquo;d need to replicate the above code wherever I wanted to trap exceptions. This is too verbose, so I looked at stripping out some of the components that prevented me from reusing a pattern matcher. Here&rsquo;s an example of what I came up with:</p>
<pre><code>int x = 5;
var fn = SwitchOn&lt;T&gt;.Match()
    .Case(y =&gt; y  y &gt;= 5 &amp;&amp; y  y &gt;10, High)
    .AsFunction();
fn(x);
</code></pre>
<p>The code is much more like a souped up &lsquo;switch&rsquo; statement rather than a souped up assignment statement as it was in Matthew&rsquo;s example. He uses a generic extension method to act as a constructor creating a context object that then constructs the pattern matcher we will really use. The type &lsquo;T&rsquo; for the construction process is thus derived from the type of the object that the Match method is invoked on. The obvious corrolary is that you need to have an object to invoke that extension method on. I didn&rsquo;t want to do it that way because I wanted to create functions that I could invoke later on.</p>
<p>First I converted the extension method to a plain old static method. Here&rsquo;s the SwitchOn&lt;T&gt; class (in Matthew&rsquo;s example it was called PatternMatchExtensions - I renamed it to get a fluent interface that made more sense for how I wanted to use it)</p>
<pre><code>public class SwitchOn&lt;T&gt;{
    public static SwitchOn&lt;T&gt; Match() {
        return new SwitchOn();
    }
    public PatternMatch&lt;T&gt; Case(
        Predicate&lt;T&gt; condition,
        Action&lt;T&gt; result) {
        var match = new PatternMatch&lt;T&gt;();
        return match.Case(condition, result);
    }
}
</code></pre>
<p>As with Matthew&rsquo;s example this object quickly gives way to an object of type PatternMatch&lt;T&gt; that gradually builds up the case list to run against the input data. In my case, though, you don&rsquo;t need to reserve space for the &lsquo;value&rsquo; object, just the type that it will have:</p>
<pre><code>public class PatternMatch&lt;T&gt;{
    private readonly List&lt;Tuple&lt;Predicate&lt;T&gt;, Action&lt;T&gt;&gt;&gt; cases
        = new List&lt;Tuple&lt;Predicate&lt;T&gt;, Action&lt;T&gt;&gt;&gt;();
    private Action&lt;T&gt; elseFunc;
    public PatternMatch&lt;T&gt; Case(Predicate&lt;T&gt; condition, Action&lt;T&gt; result) {
        cases.Add(new Tuple&lt;Predicate&lt;T&gt;, Action&lt;T&gt;&gt;(condition, result));
        return this;
    }
    public PatternMatch&lt;T&gt; Else(Action&lt;T&gt; result) {
        if (elseFunc != null)
            throw new InvalidOperationException(&quot;Cannot have multiple else cases&quot;);
        elseFunc = result;
        return this;
    public Action&lt;T&gt; AsFunction() {
        return t =&gt;{
                    if (elseFunc != null)
                        cases.Add(new Tuple&lt;Predicate&lt;T&gt;, Action&lt;T&gt;&gt;(x =&gt; true,
                            elseFunc));
                    foreach (var item in cases)
                        if (item.First(t)) {
                            item.Second(t);
                            return;
                        }
                    throw new MatchNotFoundException(&quot;Incomplete pattern match&quot;);
                };
    }
}
</code></pre>
<p>The type parameters are different because everywhere he used Func&lt;T, TResult&gt; I am using Action&lt;T&gt; - I don&rsquo;t care about the results. Another difference is that Matthew&rsquo;s &lsquo;Do&rsquo; method is now a higher-order function &lsquo;AsFunction&rsquo; returning a function to apply to a given &lsquo;T&rsquo;. We can store it and pass it around for later use.</p>
<p>Thanks to Matthew for the original inspiration. I hope that this addition fills out more of the PatternMatching picture.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://45.89.107.9/" >
    &copy;  The Wandering Glitch 2022 
  </a>
    <div>
<div class="ananke-socials">
  
    
    <a href="https://techhub.social/@aabs" target="_blank" rel="me noopener" class="mastodon ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Mastodon link" aria-label="follow on Mastodon——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 230 230;" version="1.1" viewBox="0 0 230 230"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<path d="M211.80683 139.0875c-3.1825 16.36625-28.4925 34.2775-57.5625 37.74875-15.16 1.80875-30.0825 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125 0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.3925 27.9425 21.115.7225 39.91625-5.20625 39.91625-5.20625l.86875 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23183 213.82 1.40558 165.31125.20808 116.09125c-.36375-14.61375-.14-28.39375-.14-39.91875 0-50.33 32.97625-65.0825 32.97625-65.0825C49.67058 3.45375 78.20308.2425 107.86433 0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09 0 0 32.97625 14.7525 32.97625 65.0825 0 0 .4125 37.13375-4.6 62.915" style="fill-rule:evenodd;clip-rule:evenodd;"/>
<path d="M65.68743 96.45938c0 9.01375-7.3075 16.32125-16.3225 16.32125-9.01375 0-16.32-7.3075-16.32-16.32125 0-9.01375 7.30625-16.3225 16.32-16.3225 9.015 0 16.3225 7.30875 16.3225 16.3225M124.52893 96.45938c0 9.01375-7.30875 16.32125-16.3225 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.3225 7.30875 16.3225 16.3225M183.36933 96.45938c0 9.01375-7.3075 16.32125-16.32125 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.32125 7.30875 16.32125 16.3225" fill="#fff"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
