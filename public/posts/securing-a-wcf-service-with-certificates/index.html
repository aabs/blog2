<!DOCTYPE html>
<html lang="en-au">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Securing a WCF service with Certificates | The Wandering Glitch</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="For a client and server to talk securely with message level encryption, they both require certificates to encrypt and decrypt messages from the other. Those certificates need to be produced and installed on each machine. This post shows how that can be done, and what settings are required to work with the certificates. Thanks to Mitch Denny, who wrote a very good post on the use of certificates, which helped a lot more than some of the official documentation.">
    <meta name="generator" content="Hugo 0.92.2" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="Securing a WCF service with Certificates" />
<meta property="og:description" content="For a client and server to talk securely with message level encryption, they both require certificates to encrypt and decrypt messages from the other. Those certificates need to be produced and installed on each machine. This post shows how that can be done, and what settings are required to work with the certificates. Thanks to Mitch Denny, who wrote a very good post on the use of certificates, which helped a lot more than some of the official documentation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://45.89.107.9/posts/securing-a-wcf-service-with-certificates/" /><meta property="article:section" content="posts" />



<meta itemprop="name" content="Securing a WCF service with Certificates">
<meta itemprop="description" content="For a client and server to talk securely with message level encryption, they both require certificates to encrypt and decrypt messages from the other. Those certificates need to be produced and installed on each machine. This post shows how that can be done, and what settings are required to work with the certificates. Thanks to Mitch Denny, who wrote a very good post on the use of certificates, which helped a lot more than some of the official documentation.">

<meta itemprop="wordCount" content="642">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Securing a WCF service with Certificates"/>
<meta name="twitter:description" content="For a client and server to talk securely with message level encryption, they both require certificates to encrypt and decrypt messages from the other. Those certificates need to be produced and installed on each machine. This post shows how that can be done, and what settings are required to work with the certificates. Thanks to Mitch Denny, who wrote a very good post on the use of certificates, which helped a lot more than some of the official documentation."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        The Wandering Glitch
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="Posts page">
              Posts
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
    
    <a href="https://techhub.social/@aabs" target="_blank" rel="me noopener" class="mastodon ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Mastodon link" aria-label="follow on Mastodon——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 230 230;" version="1.1" viewBox="0 0 230 230"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<path d="M211.80683 139.0875c-3.1825 16.36625-28.4925 34.2775-57.5625 37.74875-15.16 1.80875-30.0825 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125 0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.3925 27.9425 21.115.7225 39.91625-5.20625 39.91625-5.20625l.86875 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23183 213.82 1.40558 165.31125.20808 116.09125c-.36375-14.61375-.14-28.39375-.14-39.91875 0-50.33 32.97625-65.0825 32.97625-65.0825C49.67058 3.45375 78.20308.2425 107.86433 0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09 0 0 32.97625 14.7525 32.97625 65.0825 0 0 .4125 37.13375-4.6 62.915" style="fill-rule:evenodd;clip-rule:evenodd;"/>
<path d="M65.68743 96.45938c0 9.01375-7.3075 16.32125-16.3225 16.32125-9.01375 0-16.32-7.3075-16.32-16.32125 0-9.01375 7.30625-16.3225 16.32-16.3225 9.015 0 16.3225 7.30875 16.3225 16.3225M124.52893 96.45938c0 9.01375-7.30875 16.32125-16.3225 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.3225 7.30875 16.3225 16.3225M183.36933 96.45938c0 9.01375-7.3075 16.32125-16.32125 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.32125 7.30875 16.32125 16.3225" fill="#fff"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Securing a WCF service with Certificates</h1>
      
      <p class="tracked">
        By <strong>aabs</strong>
      </p>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links #000000 pr4-l w-two-thirds-l"><p>For a client and server to talk securely with message level encryption, they both require certificates to encrypt and decrypt messages from the other. Those certificates need to be produced and installed on each machine. This post shows how that can be done, and what settings are required to work with the certificates. Thanks to Mitch Denny, who wrote a <a href="http://notgartner.wordpress.com/2007/09/06/using-certificate-based-authentication-and-protection-with-windows-communication-foundation-wcf/">very good post</a> on the use of certificates, which helped a lot more than some of the official documentation. This post assumes that you&rsquo;re using Juval Lowy of IDesign&rsquo;s <a href="http://idesign.net/idesign/DesktopDefault.aspx?tabindex=5&amp;tabid=11">ServiceModelEx</a> extensions for WCF. If you&rsquo;re not, you should really consider these additions - they add declarative security and better validation amongst many other enhancements.</p>
<p>First you need to create a certificate for both the client and the server. Most examples demonstrate the scenario on a single machine thus glossing over the fact that in that situation you only need the one certificate. It obscures the real process of certificate exchange which I’ll show here.</p>
<p>The following is a little script (called setupcert.cmd) that will create a new certificate using makecert.exe, will add it to the ‘My’ cert store on the location machine hive of the registry. It will then export that cert for use on the other machine.</p>
<blockquote>
<pre><code>set CERT_NAME=%1
certmgr.exe -del -r LocalMachine -s My -c -n %CERT_NAME%
makecert.exe -sr LocalMachine -ss MY -a sha1 -n CN=%CERT_NAME% -sky exchange -pe
certmgr.exe /put /c /r LocalMachine /n %CERT_NAME% /s my %CERT_NAME%.publickey.cer
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
</blockquote>
<p>You pass one parameter to the script, which is the common name you want to give to the certificate. For instance, you could call it “ServerSide” or “ClientSide”.</p>
<p>Run the script on the client side.</p>
<blockquote>
<p>setupcert ClientSide</p>
</blockquote>
<p>You should now have a file in the current directory called ClientSide.publickey.cer. Copy this file over to the server side. You are now be able to install the client side cert on the server side.</p>
<p>Double click on the client side cert file. You should get a warning about the unknown provenance of the cert.</p>
<p><a href="%7Bstatic%7D2007/10/image1.png"><img src="%7Bstatic%7D2007/10/image-thumb1.png" alt="image">{width=&ldquo;428&rdquo; height=&ldquo;303&rdquo;}</a></p>
<p>Click the Open button. Then click on the ‘Install Certificate…’ button.</p>
<p><a href="%7Bstatic%7D2007/10/image2.png"><img src="%7Bstatic%7D2007/10/image-thumb2.png" alt="image">{width=&ldquo;300&rdquo; height=&ldquo;368&rdquo;}</a></p>
<p>You should now be running the certificate install wizard (or equivalent).</p>
<p><a href="%7Bstatic%7D2007/10/image3.png"><img src="%7Bstatic%7D2007/10/image-thumb3.png" alt="image">{width=&ldquo;364&rdquo; height=&ldquo;324&rdquo;}</a></p>
<p>Click Next. On the next page select to place the certificate in the store of your choice. A dialog box appears with the cert stores available. Check the ‘Show Physical Stores’ checkbox like so. Click OK to proceed.</p>
<p><a href="%7Bstatic%7D2007/10/image4.png"><img src="%7Bstatic%7D2007/10/image-thumb4.png" alt="image">{width=&ldquo;480&rdquo; height=&ldquo;345&rdquo;}</a></p>
<p>You will now get the confirmation window.</p>
<p><a href="%7Bstatic%7D2007/10/image5.png"><img src="%7Bstatic%7D2007/10/image-thumb5.png" alt="image">{width=&ldquo;392&rdquo; height=&ldquo;355&rdquo;}</a></p>
<p>Click Finish to complete the import. If all goes well you get this.</p>
<p><a href="%7Bstatic%7D2007/10/image6.png"><img src="%7Bstatic%7D2007/10/image-thumb6.png" alt="image">{width=&ldquo;285&rdquo; height=&ldquo;191&rdquo;}</a></p>
<p>At this stage we have a certificate installed on the client side called ClientSide. This certificate was copied to the server side and installed in the LocalMachine trusted people store. Now the reverse has to be done. Go to the server side and invoke the script from there.</p>
<blockquote>
<p>setupcert ServerSide</p>
</blockquote>
<p>copy ServerSide.publickey.cer to the client side, and from there you should repeat the import procedure outlined above. The certificates should now be configured. To confirm that, open mmc.exe and add a certificates snap-in for the local machine. On the client side you should see the ClientSide certificate in the personal certificates store.</p>
<p><a href="%7Bstatic%7D2007/10/image7.png"><img src="%7Bstatic%7D2007/10/image-thumb7.png" alt="image">{width=&ldquo;272&rdquo; height=&ldquo;289&rdquo;}</a></p>
<p>In the Trusted People certificates you should see the server side certificate.</p>
<p><a href="%7Bstatic%7D2007/10/image8.png"><img src="%7Bstatic%7D2007/10/image-thumb8.png" alt="image">{width=&ldquo;272&rdquo; height=&ldquo;289&rdquo;}</a></p>
<p>The reverse should be true for the Server side certificate stores.</p>
<h3 id="configuring-the-service-endpoints">Configuring the service endpoints</h3>
<p>The client side proxy needs to reference its certificate like so.</p>
<blockquote>
<pre><code>ServiceProxy proxy = new ServiceProxy();
SecurityHelper.SecureProxy&lt;IMyService&gt;(proxy, &quot;ClientSide&quot;);
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
</blockquote>
<p>And it can reference the server side certificate via the configuration settings.</p>
<pre><code>        &lt;endpoint
          address=&quot;http://nitrogen:8001/MyService&quot;
          binding=&quot;wsHttpBinding&quot;
          contract=&quot;SandlNtSvc.IMyService&quot;&gt;
          &lt;identity&gt;
            &lt;dns value=&quot;ServerSide&quot; /&gt;
          &lt;/identity&gt;
        &lt;/endpoint&gt;
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>The server side references its certificate via its security behavior attribute.</p>
<pre><code>    [SecurityBehavior(ServiceSecurity.Anonymous, &quot;ServerSide&quot;)]
    public class MyService : IMyService
    {
</code></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>That&rsquo;s all the configuration needed for the service and proxy to talk to each other.</p>
<p>PS. remember to delete any cert files left lying around!</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://45.89.107.9/" >
    &copy;  The Wandering Glitch 2022 
  </a>
    <div>
<div class="ananke-socials">
  
    
    <a href="https://techhub.social/@aabs" target="_blank" rel="me noopener" class="mastodon ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Mastodon link" aria-label="follow on Mastodon——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 230 230;" version="1.1" viewBox="0 0 230 230"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<path d="M211.80683 139.0875c-3.1825 16.36625-28.4925 34.2775-57.5625 37.74875-15.16 1.80875-30.0825 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125 0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.3925 27.9425 21.115.7225 39.91625-5.20625 39.91625-5.20625l.86875 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23183 213.82 1.40558 165.31125.20808 116.09125c-.36375-14.61375-.14-28.39375-.14-39.91875 0-50.33 32.97625-65.0825 32.97625-65.0825C49.67058 3.45375 78.20308.2425 107.86433 0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09 0 0 32.97625 14.7525 32.97625 65.0825 0 0 .4125 37.13375-4.6 62.915" style="fill-rule:evenodd;clip-rule:evenodd;"/>
<path d="M65.68743 96.45938c0 9.01375-7.3075 16.32125-16.3225 16.32125-9.01375 0-16.32-7.3075-16.32-16.32125 0-9.01375 7.30625-16.3225 16.32-16.3225 9.015 0 16.3225 7.30875 16.3225 16.3225M124.52893 96.45938c0 9.01375-7.30875 16.32125-16.3225 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.3225 7.30875 16.3225 16.3225M183.36933 96.45938c0 9.01375-7.3075 16.32125-16.32125 16.32125-9.01375 0-16.32125-7.3075-16.32125-16.32125 0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375 0 16.32125 7.30875 16.32125 16.3225" fill="#fff"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
